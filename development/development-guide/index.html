<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.61.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/azuredisk-csi-driver/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/azuredisk-csi-driver/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/azuredisk-csi-driver/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/azuredisk-csi-driver/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/azuredisk-csi-driver/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/azuredisk-csi-driver/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/azuredisk-csi-driver/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/azuredisk-csi-driver/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/azuredisk-csi-driver/favicons/android-192x192.png sizes=192x192><title>development-guide | AzureDisk CSI Driver</title><meta property="og:title" content="development-guide"><meta property="og:description" content="Developer guidance for how to contribute for AzureDisk CSI Driver."><meta property="og:type" content="article"><meta property="og:url" content="https://Sakuralbj.github.io/azuredisk-csi-driver/development/development-guide/"><meta property="article:modified_time" content="2020-08-27T14:56:23+08:00"><meta property="og:site_name" content="AzureDisk CSI Driver"><meta itemprop=name content="development-guide"><meta itemprop=description content="Developer guidance for how to contribute for AzureDisk CSI Driver."><meta itemprop=dateModified content="2020-08-27T14:56:23+08:00"><meta itemprop=wordCount content="489"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="development-guide"><meta name=twitter:description content="Developer guidance for how to contribute for AzureDisk CSI Driver."><link rel=preload href=/azuredisk-csi-driver/scss/main.min.125f72e5d5a3aa7d4039aab0c22c38a18b1796f8d41a399c1dbc59e50f290ecd.css as=style><link href=/azuredisk-csi-driver/scss/main.min.125f72e5d5a3aa7d4039aab0c22c38a18b1796f8d41a399c1dbc59e50f290ecd.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/azuredisk-csi-driver/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">AzureDisk CSI Driver</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/azuredisk-csi-driver/install/><span>Installation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/azuredisk-csi-driver/development/><span class=active>Development</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/azuredisk-csi-driver/features/><span>Features</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/azuredisk-csi-driver/contribute/><span>Contribution</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/azuredisk-csi-driver/example/><span>Example</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/azuredisk-csi-driver/blog/><span>Release Notes</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/azuredisk-csi-driver/faq/><span>FAQ</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/azuredisk-csi-driver/development/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Development</a></li><ul><li class="collapse show" id=azuredisk-csi-driver-development><a class="td-sidebar-link td-sidebar-link__page" id=m-azuredisk-csi-driver-development-dependencies href=/azuredisk-csi-driver/development/dependencies/>Dependency Management</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-azuredisk-csi-driver-development-design-docs href=/azuredisk-csi-driver/development/design-docs/>Design Docs</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/azuredisk-csi-driver/development/e2e/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">E2E tests</a></li><ul><li class="collapse show" id=azuredisk-csi-driver-development-e2e><a class="td-sidebar-link td-sidebar-link__page" id=m-azuredisk-csi-driver-development-e2e-e2e-tests-azuredisk href=/azuredisk-csi-driver/development/e2e/e2e-tests-azuredisk/>AzureDisk E2E tests</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-azuredisk-csi-driver-development-e2e-e2e-tests href=/azuredisk-csi-driver/development/e2e/e2e-tests/>Kubernetes E2E tests</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page active" id=m-azuredisk-csi-driver-development-development-guide href=/azuredisk-csi-driver/development/development-guide/>development-guide</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-azuredisk-csi-driver-development-future href=/azuredisk-csi-driver/development/future/>Future Plans</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/kubernetes-sigs/azuredisk-csi-driver/edit/master/content/en/development/development-guide.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/kubernetes-sigs/azuredisk-csi-driver/issues/new?title=development-guide" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/kubernetes-sigs/azuredisk-csi-driver/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#how-to-build-this-project>How to build this project</a></li><li><a href=#how-to-test-csi-driver-in-local-environment>How to test CSI driver in local environment</a><ul><li></li></ul></li><li><a href=#how-to-test-csi-driver-in-a-kubernetes-cluster>How to test CSI driver in a Kubernetes cluster</a><ul><li><a href=#how-to-update-azure-cloud-provider-library>How to update Azure cloud provider library</a></li><li><a href=#how-to-update-chart-index>How to update chart index</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://Sakuralbj.github.io/azuredisk-csi-driver/development/>Development</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://Sakuralbj.github.io/azuredisk-csi-driver/development/development-guide/>development-guide</a></li></ol></nav><div class=td-content><h1>development-guide</h1><div class=lead>Developer guidance for how to contribute for AzureDisk CSI Driver.</div><h1 id=azure-disk-csi-driver-development-guide>Azure disk CSI driver development guide</h1><h2 id=how-to-build-this-project>How to build this project</h2><ul><li>Clone repo</li></ul><pre><code class=language-console data-lang=console>$ mkdir -p $GOPATH/src/sigs.k8s.io/
$ git clone https://github.com/kubernetes-sigs/azuredisk-csi-driver $GOPATH/src/sigs.k8s.io/azuredisk-csi-driver
</code></pre><ul><li>Build CSI driver</li></ul><pre><code class=language-console data-lang=console>$ cd $GOPATH/src/sigs.k8s.io/azuredisk-csi-driver
$ make azuredisk
</code></pre><ul><li>Run verification before sending PR</li></ul><pre><code class=language-console data-lang=console>$ make verify
</code></pre><h2 id=how-to-test-csi-driver-in-local-environment>How to test CSI driver in local environment</h2><ul><li>Install <code>csc</code> tool according to <a href=https://github.com/rexray/gocsi/tree/master/csc>https://github.com/rexray/gocsi/tree/master/csc</a></li></ul><pre><code class=language-console data-lang=console>$ mkdir -p $GOPATH/src/github.com/rexray
$ cd $GOPATH/src/github.com/rexray
$ git clone https://github.com/rexray/gocsi.git
$ cd gocsi/csc
$ make build
</code></pre><h4 id=start-csi-driver-locally>Start CSI driver locally</h4><pre><code class=language-console data-lang=console>$ cd $GOPATH/src/sigs.k8s.io/azuredisk-csi-driver
$ ./_output/azurediskplugin --endpoint tcp://127.0.0.1:10000 --nodeid CSINode -v=5 &amp;
</code></pre><blockquote><p>Before running CSI driver, create &ldquo;/etc/kubernetes/azure.json&rdquo; file under testing server(it's better copy <code>azure.json</code> file from a k8s cluster with service principle configured correctly) and set <code>AZURE_CREDENTIAL_FILE</code> as following:</p></blockquote><pre><code class=language-console data-lang=console>export set AZURE_CREDENTIAL_FILE=/etc/kubernetes/azure.json
</code></pre><h4 id=1-get-plugin-info>1. Get plugin info</h4><pre><code class=language-console data-lang=console>$ csc identity plugin-info --endpoint tcp://127.0.0.1:10000
&quot;disk.csi.azure.com&quot;    &quot;v0.5.0&quot;
</code></pre><h4 id=2-create-an-azure-disk-volume>2. Create an azure disk volume</h4><pre><code class=language-console data-lang=console>$ csc controller new --endpoint tcp://127.0.0.1:10000 --cap 1,block CSIVolumeName  --req-bytes 2147483648 --params skuname=Standard_LRS,kind=managed
&quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;        2147483648      &quot;kind&quot;=&quot;managed&quot;        &quot;skuname&quot;=&quot;Standard_LRS&quot;
</code></pre><h4 id=3-attach-an-azure-disk-volume-to-a-node>3. Attach an Azure disk volume to a node</h4><pre><code class=language-console data-lang=console>$ csc controller publish --endpoint tcp://127.0.0.1:10000 --node-id k8s-agentpool-17181929-0 --cap 1,block &quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;
</code></pre><h4 id=4-stage-an-azure-disk-volume-on-a-node-format-and-mount-disk-to-a-staging-path>4. Stage an Azure disk volume on a node (format and mount disk to a staging path)</h4><pre><code class=language-console data-lang=console>$ csc node stage --endpoint tcp://127.0.0.1:10000 --cap 1,block --staging-target-path=/tmp/staging-path --pub-info devicePath=&quot;0&quot; &quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;
</code></pre><h4 id=5-publish-an-azure-disk-volume-on-a-node-bind-mount-the-volume-from-staging-to-target-path>5. Publish an Azure disk volume on a node (bind mount the volume from staging to target path)</h4><pre><code class=language-console data-lang=console>$ csc node publish --endpoint tcp://127.0.0.1:10000 --cap 1,block --staging-target-path=/tmp/staging-path --target-path=/tmp/publish-path &quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;
</code></pre><h4 id=6-unpublish-an-azure-disk-volume-on-a-node>6. Unpublish an Azure disk volume on a node</h4><pre><code class=language-console data-lang=console>$ csc node unpublish --endpoint tcp://127.0.0.1:10000 --target-path=/tmp/publish-path &quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;
</code></pre><h4 id=7-unstage-an-azure-disk-volume-on-a-node>7. Unstage an Azure disk volume on a node</h4><pre><code class=language-console data-lang=console>$ csc node unstage --endpoint tcp://127.0.0.1:10000 --staging-target-path=/tmp/staging-path &quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;
</code></pre><h4 id=8-detach-an-azure-disk-volume-from-a-node>8. Detach an Azure disk volume from a node</h4><pre><code class=language-console data-lang=console>$ csc controller unpublish --endpoint tcp://127.0.0.1:10000 --node-id k8s-agentpool-17181929-0 &quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;
</code></pre><h4 id=9-delete-an-azure-disk-volume>9. Delete an Azure disk volume</h4><pre><code class=language-console data-lang=console>$ csc controller del --endpoint tcp://127.0.0.1:10000 &quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;
</code></pre><h4 id=10-validate-volume-capabilities>10. Validate volume capabilities</h4><pre><code class=language-console data-lang=console>$ csc controller validate-volume-capabilities --endpoint tcp://127.0.0.1:10000 --cap 1,block CSIVolumeID
CSIVolumeID  true
</code></pre><h4 id=11-get-nodeid>11. Get NodeID</h4><pre><code class=language-console data-lang=console>$ csc node get-info --endpoint tcp://127.0.0.1:10000
CSINode
</code></pre><h4 id=12-create-snapshot>12. Create snapshot</h4><pre><code class=language-console data-lang=console>$ csc controller create-snapshot snapshot-name --endpoint tcp://127.0.0.1:10000 --source-volume &quot;/subscriptions/b9d2281e-dcd5-4dfd-9a97-xxx/resourceGroups/xxx/providers/Microsoft.Compute/disks/pvc-disk-dynamic-398b838f-0432-11e9-9978-000d3a00df41&quot;
</code></pre><h4 id=13-delete-snapshot>13. Delete snapshot</h4><pre><code class=language-console data-lang=console>$ csc controller delete-snapshot snapshot-name --endpoint tcp://127.0.0.1:10000
</code></pre><h4 id=14-list-snapshot>14. List snapshot</h4><pre><code class=language-console data-lang=console>$ csc controller list-snapshots --endpoint tcp://127.0.0.1:10000
</code></pre><h2 id=how-to-test-csi-driver-in-a-kubernetes-cluster>How to test CSI driver in a Kubernetes cluster</h2><ul><li>Build driver image and push image to dockerhub</li></ul><pre><code class=language-console data-lang=console># run `docker login` first
export REGISTRY=&lt;dockerhub-alias&gt;
make azuredisk-container
make push-latest
</code></pre><ul><li>Replace <code>mcr.microsoft.com/k8s/csi/azuredisk-csi:latest</code> in <a href=https://github.com/kubernetes-sigs/azuredisk-csi-driver/blob/master/deploy/csi-azuredisk-controller.yaml><code>csi-azuredisk-controller.yaml</code></a> and <a href=https://github.com/kubernetes-sigs/azuredisk-csi-driver/blob/master/deploy/csi-azuredisk-node.yaml><code>csi-azuredisk-node.yaml</code></a> with above dockerhub image urls and then follow <a href=https://github.com/kubernetes-sigs/azuredisk-csi-driver/blob/master/docs/install-csi-driver-master.md>install CSI driver master version</a></li></ul><pre><code class=language-console data-lang=console>wget -O csi-azuredisk-controller.yaml https://raw.githubusercontent.com/kubernetes-sigs/azuredisk-csi-driver/master/deploy/csi-azuredisk-controller.yaml
# edit csi-azuredisk-controller.yaml
kubectl apply -f csi-azuredisk-controller.yaml

wget -O csi-azuredisk-node.yaml https://raw.githubusercontent.com/kubernetes-sigs/azuredisk-csi-driver/master/deploy/csi-azuredisk-node.yaml
# edit csi-azuredisk-node.yaml
kubectl apply -f csi-azuredisk-node.yaml
</code></pre><h3 id=how-to-update-azure-cloud-provider-library>How to update Azure cloud provider library</h3><ul><li>get latest version of <a href=https://github.com/kubernetes/legacy-cloud-providers/tree/master/azure>github.com/kubernetes/legacy-cloud-providers</a></li></ul><blockquote><p>in following example, <code>20200619215319-3e8d72e51d7d</code> is the git version</p></blockquote><pre><code class=language-console data-lang=console># git clone https://github.com/kubernetes/legacy-cloud-providers.git
# cd ~/go/src/github.com/kubernetes/legacy-cloud-providers
# TZ=UTC 
# git --no-pager show \
  --quiet \
  --abbrev=12 \
  --date='format-local:%Y%m%d%H%M%S' \
  --format=&quot;%cd-%h&quot;
20200619215319-3e8d72e51d7d
</code></pre><ul><li>update <code>go.mod</code></li></ul><pre><code class=language-console data-lang=console>export GO111MODULE=on
#edit go.mod. add the necessary vendors in `replace`
go mod tidy
go mod vendor
</code></pre><h3 id=how-to-update-chart-index>How to update chart index</h3><pre><code class=language-console data-lang=console>helm repo index charts --url=https://raw.githubusercontent.com/kubernetes-sigs/azuredisk-csi-driver/master/charts
</code></pre><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/USERNAME/REPOSITORY/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/USERNAME/REPOSITORY/issues/new>tell us how we can improve</a>.</p><script>const yesButton=document.querySelector('.feedback--answer-yes');const noButton=document.querySelector('.feedback--answer-no');const yesResponse=document.querySelector('.feedback--response-yes');const noResponse=document.querySelector('.feedback--response-no');const disableButtons=()=>{yesButton.disabled=true;noButton.disabled=true;};const sendFeedback=(value)=>{if(typeof ga!=='function')return;const args={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:value};ga(args.command,args.hitType,args.category,args.action,args.label,args.value);};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(1);});noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(0);});</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified August 27, 2020: <a href=https://github.com/kubernetes-sigs/azuredisk-csi-driver/commit/5002fad82ab5ef838f41b766edd33de62107854e>gitpage (5002fad8)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Google Group" aria-label="Google Group"><a class=text-white target=_blank href=https://groups.google.com/forum/#!forum/kubernetes-sig-cloud-provider><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes-sigs/azuredisk-csi-driver><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>Privacy Policy</a></small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/azuredisk-csi-driver/js/main.min.081586b0ec26dd1bf0b4ee65061e0b8f00059577b8c63dfcffec340dfe7e72ae.js integrity="sha256-CBWGsOwm3RvwtO5lBh4LjwAFlXe4xj38/+w0Df5+cq4=" crossorigin=anonymous></script></body></html>